name: Deploy to GCP GKE

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'kubernetes-gcp/**'
      - '.github/workflows/deploy-gke.yml'

env:
  PROJECT_ID: omniknow-v2
  CLUSTER_NAME: omniknow-cluster
  CLUSTER_REGION: us-central1
  SERVICE_NAME: omniknow-backend
  NAMESPACE: omniknow

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Google Cloud
      uses: google-github-actions/setup-gcloud@v1
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
    
    - name: Configure Docker for GCR
      run: |
        gcloud auth configure-docker
    
    - name: Build and push image
      run: |
        cd backend
        docker build -t gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA .
        docker push gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA
        docker tag gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA gcr.io/$PROJECT_ID/$SERVICE_NAME:latest
        docker push gcr.io/$PROJECT_ID/$SERVICE_NAME:latest
    
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials $CLUSTER_NAME \
          --region $CLUSTER_REGION \
          --project $PROJECT_ID
    
    - name: Ensure namespace exists
      run: |
        kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Create/Update Kubernetes Secret
      run: |
        kubectl create secret generic omniknow-secrets -n $NAMESPACE \
          --from-literal=GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }} \
          --from-literal=PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }} \
          --from-literal=GOOGLE_SEARCH_API_KEY=${{ secrets.GOOGLE_SEARCH_API_KEY }} \
          --from-literal=GOOGLE_CSE_ID=${{ secrets.GOOGLE_CSE_ID }} \
          --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Update manifests with new image
      run: |
        sed -i "s|image: gcr.io/${PROJECT_ID}/${SERVICE_NAME}:.*|image: gcr.io/${PROJECT_ID}/${SERVICE_NAME}:${GITHUB_SHA}|g" kubernetes-gcp/backend-deployment.yaml
    
    - name: Apply Kubernetes manifests
      run: |
        kubectl apply -f kubernetes-gcp/configmap.yaml
        kubectl apply -f kubernetes-gcp/backend-deployment.yaml
        kubectl apply -f kubernetes-gcp/backend-service.yaml
        kubectl apply -f kubernetes-gcp/hpa.yaml
    
    - name: Verify deployment
      run: |
        kubectl rollout status deployment/$SERVICE_NAME -n $NAMESPACE --timeout=5m
        kubectl get pods -n $NAMESPACE
        kubectl get svc -n $NAMESPACE